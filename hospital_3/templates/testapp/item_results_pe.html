<!DOCTYPE html>
{%extends 'testapp/ahome.html' %}
{%load static%}

{%block grand_child_block%}

<!-- <script src="{%static "testapp/js/jquery-3.5.1.min.js"%}" type="text/javascript"> </script>
<script src="{%static "testapp/js/jsuser.js"%}" type="text/javascript"> </script> -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"
integrity="sha256-eGE6blurk5sHj+rmkfsGYeKyZx3M4bG+ZlFyA7Kns7E="
crossorigin="anonymous"></script>

<div class="div1"; align="center">


  {%if errors%}
  <p style="color:red";> Item Entry Creation Unsuccessful:{{errors}}</p>
  {%endif%}
{%if form and pe.status != 'APPROVED' %}
<form  method="post">

  <table >
    <tr>
      {%for field in form%}
      <td>{{ field.label }} &nbsp;&nbsp;</td>
       <td>{{ field }}</td>
      {%if forloop.counter|divisibleby:"4" %}
          <tr>
      {%endif%}
      {%endfor%}
    </tr>

  </table>
  <br>
  {%csrf_token%}
  <input type="submit" button class="btn  btn-success" value= {{title}}>


</form> <br><br>
{%endif%}
<button type="button" name="button" button class="btn  btn-primary" onclick="UserAction()" value=''> Autofill Item Details</button> <br><br>
</div><br><br><br><br><br><br>
<div class="div2"; align="center" >


  {%if pe%}
  <h3>Purchase Entry Details</h3>
  <table border="2">
    <thead>
      <th>companyname</th>
      <th>invoice_no </th>
      <th>invoice_amount</th>
      <th>tax_amount</th>
      <th>grand_total</th>
      <th>adjustment</th>
      <th>status</th>
      <th>Action</th>

    </thead>

    <tr>
      <td>{{pe.supplier_ref1.companyname}}</td>
      <td>{{pe.invoice_no}}</td>
      <td>{{pe.invoice_amount}}</td>
      <td>{{pe.tax_amount}}</td>
      <td>{{pe.grand_total}}</td>
      <td>{{pe.adjustment}}</td>
      <td >{{pe.status}}</td>

      <td>
        {% if diff_grandtot < 10 %}
        <a href="/upd_pe/{{pe.invoice_no}}" button class="btn btn-primary" value="">update_Adj</a>
        {%endif%}
        </td>
    </tr>

  </table>
  <br><br>

  {%endif%}
  <p>Grand Total:{{ie_grandtotal}}</p>
  <p>Difference :{{diff_grandtot}}</p>
  {% if diff_grandtot < 10 %}
  <a href="/pe_approval/{{pe.invoice_no}}/{{ie_grand_tot}}" button class="btn btn-primary" value="">Approve</a>
  {%endif%}
  {%if areports %}
  <h3>Item Entry List</h3>

  <table border="2">
    <thead>
      <th>item_code</th>
      <th>item_name</th>
      <th>print_name</th>
      <th>invoice_no</th>
      <th>MRP</th>
      <th>Mfd_date</th>
      <th>Exp_date</th>
      <th>Qty_in</th>
      <th>supplier_ref</th>
      <th>amount</th>
      <th>tax_amount</th>
      <th>status</th>
      {%if pe.status != 'APPROVED' %}
      <th>Action</th>
      <th>Action</th>
      <th>Action</th>
      {%endif%}
    </thead>
    {%for areport in areports%}
    {%if 'H' in areport.sch%}
    <tr style="background-color:#FF0000">
    {%else%}
    <tr>
    {%endif%}
      <td>{{areport.item_code}}</td>
      <td>{{areport.item_name}}</td>
      <td>{{areport.print_name}}</td>
      <td>{{areport.purchase_ref.invoice_no}}</td>
      <td>{{areport.MRP}}</td>
      <td>{{areport.Mfd_date}}</td>
      <td>{{areport.Exp_date}}</td>
      <td>{{areport.Qty_in}}</td>
      <td>{{areport.supplier_ref.companyname}}</td>
      <td>{{areport.amount}}</td>
      <td>{{areport.tax_amount}}</td>
      <td>{{areport.status}}</td>
      <!-- <td> <a class="btn btn-success" href="/addtoPE/{{areport.id}}" role="button">Add to PE</a></td> -->
      {%if areport.status != 'APPROVED' %}
      <td><a href="/del_ie/{{areport.id}}/{{areport.purchase_ref.invoice_no}}" class="btn btn-success "> delete</a></td>
      <td><a href="/upd_ie/{{areport.id}}/{{areport.purchase_ref.invoice_no}}" class="btn btn-secondary "> update</a></td>
      <td><a href="/clone_ie/{{areport.id}}/{{areport.purchase_ref.invoice_no}}" class="btn btn-success"> clone</a></td>
      {%endif%}
    </tr>
    {%endfor%}
  </table>
  {%else%}
  <h1>No report records</h1>
  {%endif%}

</div>


  <!-- onload="mymessage()" -->

</script>
<script>
var abc=[]
function mymessage() {
  // alert("This message was triggered from the onload event");
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           // alert(this.responseText);
           // document.getElementById("xxx").innerHTML = xhttp.responseText;
          json_data=JSON.parse(this.responseText);
          // alert(json_data);
          abc=json_data;    // assigning to global var abc, used by AutoComplete
          // alert(abc);

       }
  };
  s="http://127.0.0.1:8000/im_list_japi/";

  // alert(s)
  xhttp.open("GET",s, true);
  xhttp.setRequestHeader("Content-type", "application/json");

  xhttp.send();
  // alert(xhttp.responseText);
}
</script>
</head>

<body onload="mymessage()">
</body>

</div>

<script type="text/javascript">
$("#id_item_name").click(function(){


$(this).autocomplete({
  source:abc
},
{
autofocus:true,
minLength:2,
});
});



//Fills HSN, print_name,tax_percent, item_code, Mfd_by,BatchNo, sch

function UserAction() {
  // alert('hi from User Action');
  var x= document.getElementById("id_item_name").value;
  // alert(x);
  var xhttp = new XMLHttpRequest();

  xhttp.onreadystatechange = function() {
       if (this.readyState == 4 && this.status == 200) {
           // alert(this.responseText);
           // document.getElementById("xxx").innerHTML = xhttp.responseText;

          json_data=JSON.parse(this.responseText);

          for ( k in json_data){
            // alert(k);

          document.getElementById("id_item_code").value=json_data[k].item_code;
          document.getElementById("id_HSN_code").value=json_data[k].HSN_code;
          document.getElementById("id_print_name").value=json_data[k].print_name;
          document.getElementById("id_Mfd_by").value=json_data[k].Mfd_by;
          document.getElementById("id_MRP").value=json_data[k].MRP;
          document.getElementById("id_BatchNo").value=json_data[k].BatchNo;
          document.getElementById("id_tax_percent").value=json_data[k].tax_percent;
          document.getElementById("id_sch").value=json_data[k].sch;
            // alert(json_data[k].print_name);

          }

       }
  };
  s="http://127.0.0.1:8000/im_entry/";
  s1=s+x+'/';
  // alert(s1);
  xhttp.open("GET",s1, true);
  xhttp.setRequestHeader("Content-type", "application/json");

  xhttp.send();
  // alert(xhttp.response.meta.statusCode);
  // alert(xhttp.responseText);
  // document.getElementById("xxx").innerHTML = xhttp.responseText.json();
}


</script>


{%endblock%}
